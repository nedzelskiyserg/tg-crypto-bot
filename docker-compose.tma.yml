# TG CRYPTO BOT — Telegram Mini App + Backend API + Bot
# Запуск: docker compose -f docker-compose.tma.yml up -d

services:
  # FastAPI backend (API + Mini App static files)
  app:
    build:
      context: .
      dockerfile: Dockerfile.tma
      network: host
    container_name: tma_app
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - DATABASE_URL=sqlite+aiosqlite:////app/data/app.db
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - GOOGLE_SHEETS_ID=${GOOGLE_SHEETS_ID:-}
      - GOOGLE_CREDENTIALS_PATH=${GOOGLE_CREDENTIALS_PATH:-/app/credentials.json}
    volumes:
      - ./data:/app/data
      - ./credentials.json:/app/credentials.json:ro
      - ./admins.xlsx:/app/backend/admins.xlsx:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; r=urllib.request.urlopen('http://127.0.0.1:8000/health', timeout=5); exit(0 if r.getcode() == 200 else 1)"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - tma_network

  # Telegram bot (polling)
  bot:
    build:
      context: .
      dockerfile: Dockerfile.tma
      network: host
    container_name: tma_bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - USE_GOOGLE_SHEETS=${USE_GOOGLE_SHEETS:-true}
      - GOOGLE_SHEETS_ID=${GOOGLE_SHEETS_ID:-}
      - GOOGLE_CREDENTIALS_PATH=${GOOGLE_CREDENTIALS_PATH:-/app/credentials.json}
      - MENU_FILE=/app/menu.xlsx
      - API_BASE_URL=http://app:8000/api
    volumes:
      - ./credentials.json:/app/credentials.json:ro
      - ./menu.xlsx:/app/menu.xlsx:ro
    depends_on:
      app:
        condition: service_healthy
    command: ["python", "-m", "bot.main"]
    networks:
      - tma_network

networks:
  tma_network:
    driver: bridge
